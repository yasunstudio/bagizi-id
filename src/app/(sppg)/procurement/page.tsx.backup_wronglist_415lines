/**/**

 * @fileoverview Procurement Dashboard - Business Process Overview * @fileoverview Procurement Dashboard - Business Process Overview

 * @version Next.js 15.5.4 / Auth.js v5 / Prisma 6.17.1 * @version Next.js 15.5.4 / Auth.js v5 / Prisma 6.17.1

 * @author Bagizi-ID Development Team * @author Bagizi-ID Development Team

 * @see {@link /docs/PROCUREMENT_NAVIGATION_IMPLEMENTATION.md} Navigation Structure * @see {@link /docs/PROCUREMENT_NAVIGATION_IMPLEMENTATION.md} Navigation Structure

 * @see {@link /docs/copilot-instructions.md} Development Guidelines * @see {@link /docs/copilot-instructions.md} Development Guidelines

 *  * 

 * ARCHITECTURE: Business Process View (Option A) * ARCHITECTURE: Business Process View (Option A)

 * - Dashboard as overview/entry point * - Dashboard as overview/entry point

 * - Sub-modules for workflow steps: * - Sub-modules for workflow steps:

 *   1. Planning   → /procurement/plans *   1. Planning   → /procurement/plans

 *   2. Ordering   → /procurement/orders (main list) *   2. Ordering   → /procurement/orders (main list)

 *   3. Receiving  → /procurement/receipts *   3. Receiving  → /procurement/receipts

 *   4. Payment    → /procurement/payments *   4. Payment    → /procurement/payments

 *  * 

 * ENTERPRISE-GRADE FEATURES: * ENTERPRISE-GRADE FEATURES:

 * - Server Component with SSR * - Server Component with SSR

 * - Authentication & Authorization (RBAC) * - Authentication & Authorization (RBAC)

 * - Multi-tenant data isolation (sppgId filtering) * - Multi-tenant data isolation (sppgId filtering)

 * - Real-time statistics from database * - Real-time statistics

 * - Quick action buttons * - Quick action buttons

 * - Recent activities feed * - Recent activities feed

 * - Pending approvals * - Pending approvals

 * - Low stock alerts * - Low stock alerts

 * - Upcoming deliveries * - Upcoming deliveries

 * - Dark mode support * - Dark mode support

 * - SEO optimization * - SEO optimization

 */ */



import { Metadata } from 'next'import { Metadata } from 'next'

import { redirect } from 'next/navigation'import { redirect } from 'next/navigation'

import { auth } from '@/auth'import { auth } from '@/auth'

import { checkSppgAccess } from '@/lib/permissions'import { checkSppgAccess } from '@/lib/permissions'

import { db } from '@/lib/prisma'import { db } from '@/lib/prisma'

import { import { 

  ProcurementStats,  ProcurementStats,

  RecentActivities,  RecentActivities,

  PendingApprovals,  PendingApprovals,

  LowStockAlerts,  LowStockAlerts,

  UpcomingDeliveries,  UpcomingDeliveries,

  QuickActionsGrid  QuickActionsGrid

} from '@/features/sppg/procurement/dashboard/components'} from '@/features/sppg/procurement/dashboard/components'

import {import {

  Breadcrumb,  Breadcrumb,

  BreadcrumbItem,  BreadcrumbItem,

  BreadcrumbLink,  BreadcrumbLink,

  BreadcrumbList,  BreadcrumbList,

  BreadcrumbPage,  BreadcrumbPage,

  BreadcrumbSeparator,  BreadcrumbSeparator,

} from '@/components/ui/breadcrumb'} from '@/components/ui/breadcrumb'

import { Separator } from '@/components/ui/separator'import { Separator } from '@/components/ui/separator'

import { ShoppingCart, Home } from 'lucide-react'import { ShoppingCart, Home } from 'lucide-react'



// ================================ METADATA ================================// ================================ METADATA ================================



export const metadata: Metadata = {export const metadata: Metadata = {

  title: 'Procurement Dashboard | Bagizi SPPG',  title: 'Procurement Dashboard | Bagizi SPPG',

  description: 'Dashboard overview untuk manajemen pengadaan bahan baku SPPG. Monitor status pembelian, approval, delivery, dan payment secara real-time.',  description: 'Dashboard overview untuk manajemen pengadaan bahan baku SPPG. Monitor status pembelian, approval, delivery, dan payment secara real-time.',

  keywords: [  keywords: [

    'procurement dashboard',    'procurement dashboard',

    'pengadaan SPPG',    'pengadaan SPPG',

    'procurement overview',    'procurement overview',

    'purchase order monitoring',    'purchase order monitoring',

    'procurement analytics',    'procurement analytics',

    'supplier management dashboard'    'supplier management dashboard'

  ],  ],

  openGraph: {  openGraph: {

    title: 'Procurement Dashboard - Bagizi SPPG',    title: 'Procurement Dashboard - Bagizi SPPG',

    description: 'Monitor dan kelola seluruh proses procurement SPPG',    description: 'Monitor dan kelola seluruh proses procurement SPPG',

    type: 'website',    type: 'website',

  },  },

}}



// ================================ HELPER FUNCTIONS ================================// ================================ HELPER FUNCTIONS ================================



/**/**

 * Get procurement statistics for dashboard * Get procurement statistics for dashboard

 * Fetches real data from database for current SPPG * Fetches real data from database for current SPPG

 */ */

async function getProcurementStats(sppgId: string) {async function getProcurementStats(sppgId: string) {

  // Get orders statistics  // Get orders statistics

  const ordersCount = await db.procurement.groupBy({  const ordersCount = await db.procurement.groupBy({

    by: ['status'],    by: ['status'],

    where: { sppgId },    where: { sppgId },

    _count: { _all: true },    _count: { _all: true },

    _sum: { totalAmount: true }    _sum: { totalAmount: true }

  })  })



  const orders = {  const orders = {

    total: ordersCount.reduce((sum, item) => sum + item._count._all, 0),    total: ordersCount.reduce((sum, item) => sum + item._count._all, 0),

    pending: ordersCount.find(item => item.status === 'PENDING_APPROVAL')?._count._all || 0,    pending: ordersCount.find(item => item.status === 'PENDING_APPROVAL')?._count._all || 0,

    approved: ordersCount.find(item => item.status === 'APPROVED')?._count._all || 0,    approved: ordersCount.find(item => item.status === 'APPROVED')?._count._all || 0,

    completed: ordersCount.find(item => item.status === 'COMPLETED')?._count._all || 0,    completed: ordersCount.find(item => item.status === 'COMPLETED')?._count._all || 0,

    totalValue: ordersCount.reduce((sum, item) => sum + (item._sum.totalAmount || 0), 0),    totalValue: ordersCount.reduce((sum, item) => sum + (item._sum.totalAmount || 0), 0),

    thisMonth: 0 // TODO: Add date filter for current month    thisMonth: 0 // TODO: Add date filter

  }  }



  // Get plans statistics    // Get plans statistics  

  const plansCount = await db.procurementPlan.groupBy({  const plansCount = await db.procurementPlan.groupBy({

    by: ['status'],    by: ['status'],

    where: { sppgId },    where: { sppgId },

    _count: { _all: true },    _count: { _all: true },

    _sum: { totalBudget: true, usedBudget: true }    _sum: { totalBudget: true, usedBudget: true }

  })  })



  const plans = {  const plans = {

    total: plansCount.reduce((sum, item) => sum + item._count._all, 0),    total: plansCount.reduce((sum, item) => sum + item._count._all, 0),

    active: plansCount.find(item => item.status === 'ACTIVE')?._count._all || 0,    active: plansCount.find(item => item.status === 'ACTIVE')?._count._all || 0,

    completed: plansCount.find(item => item.status === 'COMPLETED')?._count._all || 0,    completed: plansCount.find(item => item.status === 'COMPLETED')?._count._all || 0,

    totalBudget: plansCount.reduce((sum, item) => sum + (item._sum.totalBudget || 0), 0),    totalBudget: plansCount.reduce((sum, item) => sum + (item._sum.totalBudget || 0), 0),

    usedBudget: plansCount.reduce((sum, item) => sum + (item._sum.usedBudget || 0), 0),    usedBudget: plansCount.reduce((sum, item) => sum + (item._sum.usedBudget || 0), 0),

    remainingBudget: 0 // Will calculate after    remainingBudget: 0 // Will calculate after

  }  }

  plans.remainingBudget = plans.totalBudget - plans.usedBudget  plans.remainingBudget = plans.totalBudget - plans.usedBudget



  // Get suppliers statistics  // Get suppliers statistics

  const suppliersCount = await db.supplier.groupBy({  const suppliersCount = await db.supplier.groupBy({

    by: ['status'],    by: ['status'],

    where: { sppgId },    where: { sppgId },

    _count: { _all: true }    _count: { _all: true }

  })  })



  const suppliers = {  const suppliers = {

    total: suppliersCount.reduce((sum, item) => sum + item._count._all, 0),    total: suppliersCount.reduce((sum, item) => sum + item._count._all, 0),

    active: suppliersCount.find(item => item.status === 'ACTIVE')?._count._all || 0,    active: suppliersCount.find(item => item.status === 'ACTIVE')?._count._all || 0,

    preferred: await db.supplier.count({     preferred: await db.supplier.count({ 

      where: { sppgId, status: 'ACTIVE', supplierType: 'PREFERRED' }       where: { sppgId, status: 'ACTIVE', supplierType: 'PREFERRED' } 

    }),    }),

    newThisMonth: 0 // TODO: Add date filter for current month    newThisMonth: 0 // TODO: Add date filter

  }  }



  return { orders, plans, suppliers }  return { orders, plans, suppliers }

}}



// ================================ MAIN COMPONENT ================================// ================================ MAIN COMPONENT ================================



/**/**

 * Procurement Dashboard Page (Server Component) * Procurement Dashboard Page (Server Component)

 *  * 

 * Purpose: Entry point untuk procurement module dengan overview lengkap * Purpose: Entry point untuk procurement module dengan overview lengkap

 *  * 

 * Business Process Flow: * Business Process Flow:

 * 1. User lands on dashboard → Lihat stats & recent activities * 1. User lands on dashboard → Lihat stats & recent activities

 * 2. Click "Perencanaan" → /procurement/plans (planning) * 2. Click "Perencanaan" → /procurement/plans (planning)

 * 3. Click "Purchase Orders" → /procurement/orders (main list) * 3. Click "Purchase Orders" → /procurement/orders (main list)

 * 4. Click "Penerimaan Barang" → /procurement/receipts (receiving) * 4. Click "Penerimaan Barang" → /procurement/receipts (receiving)

 * 5. Click "Pembayaran" → /procurement/payments (payment) * 5. Click "Pembayaran" → /procurement/payments (payment)

 *  * 

 * Features: * Features:

 * - Real-time procurement statistics * - Real-time procurement statistics

 * - Pending approvals count * - Pending approvals count

 * - Recent activities timeline * - Recent activities timeline

 * - Low stock alerts * - Low stock alerts

 * - Upcoming deliveries schedule * - Upcoming deliveries schedule

 * - Quick action buttons * - Quick action buttons

 */ * - Authorization guard with role-based access

export default async function ProcurementDashboardPage() { * - Multi-tenant data isolation (sppgId filtering)

  // ================================ AUTHENTICATION ================================ * - URL search params for filters (supplier, plan, status, method)

   * - Quick action buttons (Create, View Suppliers, View Plans)

  const session = await auth() * - Statistics cards (Total, Pending, Approved, Completed)

   * - Client component integration (ProcurementList)

  if (!session?.user) { * - Breadcrumb navigation

    redirect('/login') * - Responsive layout

  } */

export default async function ProcurementPage({ searchParams }: ProcurementPageProps) {

  // ================================ AUTHORIZATION ================================  const resolvedSearchParams = await searchParams

    

  const userRole = session.user.userRole  // ================================ AUTHENTICATION ================================

  const sppgId = session.user.sppgId  

  const session = await auth()

  if (!sppgId) {  

    redirect('/access-denied?reason=no_sppg')  // Redirect if not authenticated

  }  if (!session?.user) {

    redirect('/login?callbackUrl=/procurement')

  // Verify SPPG access  }

  const sppg = await checkSppgAccess(sppgId)

  if (!sppg) {  // ================================ AUTHORIZATION ================================

    redirect('/access-denied?reason=invalid_sppg')  

  }  // Check SPPG access (multi-tenant security)

  const sppgId = session.user.sppgId

  // Check if user has procurement access  

  const canAccessProcurement = [  if (!sppgId) {

    'SPPG_KEPALA',    redirect('/access-denied?reason=no-sppg')

    'SPPG_ADMIN',  }

    'SPPG_AKUNTAN',

    'SPPG_PRODUKSI_MANAGER',  // Check role permissions for procurement management

    'SPPG_STAFF',  const userRole = session.user.userRole

    'SPPG_STAFF_QC'  const canManageProcurement = userRole ? [

  ].includes(userRole || '')    'SPPG_KEPALA',

    'SPPG_ADMIN',

  if (!canAccessProcurement) {    'SPPG_AKUNTAN',

    redirect('/access-denied?reason=insufficient_permissions')    'SPPG_PRODUKSI_MANAGER',

  }  ].includes(userRole) : false



  // ================================ DATA FETCHING ================================  const canViewOnly = userRole === 'SPPG_VIEWER'



  const stats = await getProcurementStats(sppgId)  // ================================ DATA FETCHING ================================

  

  // ================================ RENDER ================================  // Get procurement statistics (async - will be replaced with API call)

  const stats = await getProcurementStats(sppgId)

  return (

    <div className="container mx-auto py-6 space-y-6">  // Extract URL search params for filtering

      {/* Breadcrumb Navigation */}  const filters = {

      <Breadcrumb>    supplierId: resolvedSearchParams?.supplier,

        <BreadcrumbList>    planId: resolvedSearchParams?.plan,

          <BreadcrumbItem>    status: resolvedSearchParams?.status,

            <BreadcrumbLink href="/dashboard">    method: resolvedSearchParams?.method,

              <Home className="h-4 w-4" />  }

            </BreadcrumbLink>

          </BreadcrumbItem>  // ================================ RENDER ================================

          <BreadcrumbSeparator />

          <BreadcrumbItem>  return (

            <BreadcrumbPage className="flex items-center gap-2">    <div className="container mx-auto py-6 space-y-6">

              <ShoppingCart className="h-4 w-4" />      {/* ================================ HEADER ================================ */}

              Procurement Dashboard      

            </BreadcrumbPage>      <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">

          </BreadcrumbItem>        <div className="space-y-1">

        </BreadcrumbList>          <div className="flex items-center gap-2">

      </Breadcrumb>            <ShoppingCart className="h-6 w-6 text-primary" />

            <h1 className="text-3xl font-bold tracking-tight">

      {/* Page Header */}              Manajemen Procurement

      <div className="space-y-2">            </h1>

        <h1 className="text-3xl font-bold tracking-tight flex items-center gap-3">          </div>

          <ShoppingCart className="h-8 w-8 text-primary" />          <p className="text-muted-foreground">

          Procurement Dashboard            Kelola pengadaan bahan baku dan supplier untuk program gizi SPPG

        </h1>          </p>

        <p className="text-muted-foreground">        </div>

          Monitor dan kelola seluruh proses pengadaan bahan baku untuk {sppg.sppgName}

        </p>        {/* Quick Actions */}

      </div>        {canManageProcurement && (

          <div className="flex flex-wrap gap-2">

      <Separator />            <Button asChild>

              <Link href="/procurement/new">

      {/* Statistics Cards */}                <Plus className="mr-2 h-4 w-4" />

      <ProcurementStats stats={stats} />                Buat Procurement Baru

              </Link>

      {/* Quick Actions Grid */}            </Button>

      <QuickActionsGrid />            <Button asChild variant="outline">

              <Link href="/procurement/suppliers">

      <Separator />                <Users className="mr-2 h-4 w-4" />

                Kelola Supplier

      {/* Main Content Grid */}              </Link>

      <div className="grid gap-6 lg:grid-cols-2">            </Button>

        {/* Left Column */}            <Button asChild variant="outline">

        <div className="space-y-6">              <Link href="/procurement/plans">

          {/* Pending Approvals */}                <FileText className="mr-2 h-4 w-4" />

          <PendingApprovals sppgId={sppgId} userRole={userRole} />                Lihat Rencana

              </Link>

          {/* Low Stock Alerts */}            </Button>

          <LowStockAlerts sppgId={sppgId} />          </div>

        </div>        )}

      </div>

        {/* Right Column */}

        <div className="space-y-6">      <Separator />

          {/* Recent Activities */}

          <RecentActivities sppgId={sppgId} />      {/* ================================ BREADCRUMB ================================ */}

      

          {/* Upcoming Deliveries */}      <nav className="flex items-center space-x-2 text-sm text-muted-foreground">

          <UpcomingDeliveries sppgId={sppgId} />        <Link 

        </div>          href="/dashboard" 

      </div>          className="hover:text-foreground transition-colors"

        >

      {/* Footer Info */}          Dashboard

      <div className="mt-8 p-4 bg-muted/50 dark:bg-muted/20 rounded-lg border border-border/50">        </Link>

        <div className="flex items-start gap-3">        <span>/</span>

          <ShoppingCart className="h-5 w-5 text-muted-foreground mt-0.5" />        <span className="text-foreground font-medium">Procurement</span>

          <div className="space-y-1">      </nav>

            <p className="text-sm font-medium">Procurement Workflow</p>

            <p className="text-sm text-muted-foreground">      {/* ================================ STATISTICS CARDS ================================ */}

              <span className="font-medium">Planning</span> → Create procurement plans dengan budget allocation      

              {' • '}      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">

              <span className="font-medium">Ordering</span> → Generate purchase orders dari plans        {/* Total Procurement */}

              {' • '}        <Card>

              <span className="font-medium">Receiving</span> → Quality control dan receipt barang          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">

              {' • '}            <CardTitle className="text-sm font-medium">

              <span className="font-medium">Payment</span> → Track payment status dan due dates              Total Procurement

            </p>            </CardTitle>

          </div>            <Package className="h-4 w-4 text-muted-foreground" />

        </div>          </CardHeader>

      </div>          <CardContent>

    </div>            <div className="text-2xl font-bold">{stats.total}</div>

  )            <p className="text-xs text-muted-foreground">

}              Semua procurement order

            </p>
          </CardContent>
        </Card>

        {/* Pending Approval */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              Menunggu Persetujuan
            </CardTitle>
            <FileText className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats.pending}</div>
            <p className="text-xs text-muted-foreground">
              Perlu review dan approval
            </p>
          </CardContent>
        </Card>

        {/* Approved */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              Disetujui
            </CardTitle>
            <TrendingUp className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stats.approved}</div>
            <p className="text-xs text-muted-foreground">
              Procurement yang disetujui
            </p>
          </CardContent>
        </Card>

        {/* Total Value */}
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              Total Nilai
            </CardTitle>
            <ShoppingCart className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
              }).format(stats.totalValue)}
            </div>
            <p className="text-xs text-muted-foreground">
              Nilai total procurement
            </p>
          </CardContent>
        </Card>
      </div>

      {/* ================================ ACTIVE FILTERS DISPLAY ================================ */}
      
      {(filters.supplierId || filters.planId || filters.status || filters.method) && (
        <Card>
          <CardHeader>
            <CardTitle className="text-base">Filter Aktif</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex flex-wrap gap-2">
              {filters.supplierId && (
                <Badge variant="secondary">
                  Supplier ID: {filters.supplierId}
                </Badge>
              )}
              {filters.planId && (
                <Badge variant="secondary">
                  Plan ID: {filters.planId}
                </Badge>
              )}
              {filters.status && (
                <Badge variant="secondary">
                  Status: {filters.status}
                </Badge>
              )}
              {filters.method && (
                <Badge variant="secondary">
                  Method: {filters.method}
                </Badge>
              )}
              <Button
                asChild
                variant="ghost"
                size="sm"
                className="h-7 px-2"
              >
                <Link href="/procurement">
                  Hapus Semua Filter
                </Link>
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* ================================ VIEW-ONLY NOTICE ================================ */}
      
      {canViewOnly && (
        <Card className="border-yellow-500/50 bg-yellow-500/10">
          <CardHeader>
            <CardTitle className="text-base flex items-center gap-2">
              <FileText className="h-4 w-4" />
              Mode Tampilan Saja
            </CardTitle>
            <CardDescription>
              Anda memiliki akses read-only. Hubungi administrator untuk izin edit.
            </CardDescription>
          </CardHeader>
        </Card>
      )}

      {/* ================================ MAIN CONTENT - PROCUREMENT LIST ================================ */}
      
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <ShoppingCart className="h-5 w-5" />
            Daftar Procurement
          </CardTitle>
          <CardDescription>
            Semua procurement order untuk SPPG Anda
          </CardDescription>
        </CardHeader>
        <CardContent>
          {/* 
            Client Component: ProcurementList
            - Full TanStack Table integration
            - 7 columns with comprehensive features
            - Client-side search and filtering
            - CRUD operations (view/edit/delete)
            - Loading/error/empty states
            - 693 lines of enterprise-grade code
          */}
          <ProcurementList
            supplierId={filters.supplierId}
            planId={filters.planId}
          />
        </CardContent>
      </Card>

      {/* ================================ FOOTER INFO ================================ */}
      
      <Card>
        <CardContent className="pt-6">
          <div className="flex flex-col gap-4 text-sm text-muted-foreground">
            <div className="flex items-start gap-2">
              <FileText className="h-4 w-4 mt-0.5 flex-shrink-0" />
              <div>
                <strong>Tentang Procurement:</strong>
                <p className="mt-1">
                  Sistem procurement membantu Anda mengelola pengadaan bahan baku
                  dari supplier untuk program gizi SPPG. Setiap procurement order
                  terintegrasi dengan perencanaan menu dan manajemen inventori.
                </p>
              </div>
            </div>
            
            <Separator />
            
            <div className="flex items-start gap-2">
              <TrendingUp className="h-4 w-4 mt-0.5 flex-shrink-0" />
              <div>
                <strong>Workflow Procurement:</strong>
                <ol className="mt-1 list-decimal list-inside space-y-1">
                  <li>Buat rencana procurement berdasarkan menu planning</li>
                  <li>Pilih supplier dan buat purchase order</li>
                  <li>Submit untuk approval (jika diperlukan)</li>
                  <li>Proses pengadaan dan penerimaan barang</li>
                  <li>Update inventori dan tracking kualitas</li>
                </ol>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
