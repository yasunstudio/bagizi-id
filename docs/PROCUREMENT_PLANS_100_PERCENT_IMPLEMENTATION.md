# Procurement Plans 100% Implementation Guide

**Status:** ‚úÖ Schemas & Types Updated | üîÑ UI Implementation In Progress  
**Date:** November 1, 2025  
**Author:** Bagizi-ID Development Team

---

## üìä Implementation Status Overview

| Component | Schema | Types | API | UI Form | UI Display | Status |
|-----------|--------|-------|-----|---------|------------|--------|
| **Menu Plan Integration** | ‚úÖ | ‚úÖ | ‚è≥ | ‚è≥ | ‚è≥ | **40%** |
| **Approval Workflow** | ‚úÖ | ‚úÖ | ‚è≥ | ‚è≥ | ‚è≥ | **40%** |
| **Related Records** | ‚úÖ | ‚ùå | ‚ùå | N/A | ‚è≥ | **20%** |
| **Form Fields Complete** | ‚úÖ | ‚úÖ | ‚è≥ | ‚è≥ | ‚úÖ | **60%** |

**Overall Progress:** **40% ‚Üí Target: 100%**

---

## üéØ Phase 1: Menu Plan Integration (Priority 1)

### **What's Already Done** ‚úÖ
- ‚úÖ Schema: `menuPlanId`, `menuBasedBudget`, `autoGeneratedItems` fields added
- ‚úÖ Types: `CreatePlanFormInput` updated with menu plan fields
- ‚úÖ Validation: Zod schemas updated
- ‚úÖ Components: `ProcurementFromMenuButton` exists (needs refactor)

### **What Needs to be Done** ‚è≥

#### 1. Update PlanForm with Menu Plan Mode Toggle

**File:** `src/features/sppg/procurement/plans/components/PlanForm.tsx`

```typescript
'use client'

import { useState } from 'react'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { useApprovedMenuPlans } from '@/features/sppg/menu/hooks/useMenuPlans' // Create this

export function PlanForm({ mode, initialData, onSuccess }: PlanFormProps) {
  const [inputMode, setInputMode] = useState<'manual' | 'from-menu'>('manual')
  const { data: menuPlans, isLoading } = useApprovedMenuPlans()
  
  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)}>
        {/* Mode Toggle */}
        <Tabs value={inputMode} onValueChange={(v) => setInputMode(v as 'manual' | 'from-menu')}>
          <TabsList className="grid w-full grid-cols-2">
            <TabsTrigger value="manual">Manual Input</TabsTrigger>
            <TabsTrigger value="from-menu">
              From Menu Plan {menuPlans?.length ? `(${menuPlans.length})` : ''}
            </TabsTrigger>
          </TabsList>

          {/* Manual Mode */}
          <TabsContent value="manual">
            {/* Existing form fields */}
          </TabsContent>

          {/* From Menu Mode */}
          <TabsContent value="from-menu">
            {/* Menu Plan Selection */}
            <FormField
              control={form.control}
              name="menuPlanId"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Pilih Menu Plan</FormLabel>
                  <Select
                    onValueChange={(value) => {
                      field.onChange(value)
                      handleMenuPlanSelect(value) // Auto-populate fields
                    }}
                    value={field.value}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Pilih menu plan yang sudah disetujui" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {menuPlans?.map((plan) => (
                        <SelectItem key={plan.id} value={plan.id}>
                          {plan.name} - {plan.program.name}
                          <span className="text-xs text-muted-foreground ml-2">
                            {format(plan.startDate, 'MMM yyyy')} ({plan.totalMenus} menus)
                          </span>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormDescription>
                    Budget dan target akan dihitung otomatis dari menu plan
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Auto-populated fields (read-only) */}
            {form.watch('menuPlanId') && (
              <Card className="mt-4 border-primary/20 bg-primary/5">
                <CardHeader>
                  <CardTitle className="text-base">Data dari Menu Plan</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span className="text-muted-foreground">Estimated Budget:</span>
                      <p className="font-semibold">
                        {formatCurrency(form.watch('menuBasedBudget'))}
                      </p>
                    </div>
                    <div>
                      <span className="text-muted-foreground">Total Items:</span>
                      <p className="font-semibold">
                        {form.watch('autoGeneratedItems')?.length || 0}
                      </p>
                    </div>
                  </div>
                  
                  {/* Can still edit these fields */}
                  <FormField name="totalBudget" />
                  <FormField name="targetRecipients" />
                  <FormField name="targetMeals" />
                </CardContent>
              </Card>
            )}
          </TabsContent>
        </Tabs>

        {/* Submit buttons */}
      </form>
    </Form>
  )
}

// Handler to auto-populate from menu plan
const handleMenuPlanSelect = async (menuPlanId: string) => {
  const menuPlanData = await fetchMenuPlanData(menuPlanId)
  
  form.setValue('programId', menuPlanData.programId)
  form.setValue('menuBasedBudget', menuPlanData.totalEstimatedCost)
  form.setValue('totalBudget', menuPlanData.totalEstimatedCost)
  form.setValue('autoGeneratedItems', menuPlanData.suggestedItems)
  form.setValue('planName', `Procurement from ${menuPlanData.name}`)
  
  // Calculate targets
  form.setValue('targetMeals', menuPlanData.totalMenus * menuPlanData.plannedPortions)
  form.setValue('targetRecipients', menuPlanData.plannedPortions)
}
```

#### 2. Create Menu Plans Hook

**File:** `src/features/sppg/menu/hooks/useMenuPlans.ts`

```typescript
import { useQuery } from '@tanstack/react-query'
import { menuPlansApi } from '../api'

export function useApprovedMenuPlans() {
  return useQuery({
    queryKey: ['menu-plans', 'approved'],
    queryFn: () => menuPlansApi.getAll({ status: 'APPROVED', isArchived: false }),
    select: (response) => response.data,
  })
}

export function useMenuPlanData(menuPlanId?: string) {
  return useQuery({
    queryKey: ['menu-plans', menuPlanId],
    queryFn: () => menuPlansApi.getById(menuPlanId!),
    enabled: !!menuPlanId,
    select: (response) => ({
      ...response.data,
      suggestedItems: calculateSuggestedItems(response.data),
    }),
  })
}

function calculateSuggestedItems(menuPlan: MenuPlan) {
  // Group menu assignments by ingredient
  // Calculate total quantities needed
  // Return list of {itemName, category, quantity, estimatedCost}
  return menuPlan.assignments.reduce((items, assignment) => {
    // Logic to aggregate ingredients
    return items
  }, [])
}
```

#### 3. Update API to Handle Menu Plan Integration

**File:** `src/app/api/sppg/procurement/plans/route.ts`

```typescript
export async function POST(request: NextRequest) {
  // ... existing auth checks ...
  
  const body = await request.json()
  const validated = createPlanAPISchema.safeParse(body)
  
  if (!validated.success) {
    return Response.json({ error: 'Validation failed', details: validated.error }, { status: 400 })
  }
  
  // If menuPlanId provided, fetch and validate
  if (validated.data.menuPlanId) {
    const menuPlan = await db.menuPlan.findFirst({
      where: {
        id: validated.data.menuPlanId,
        sppgId: session.user.sppgId,
        status: 'APPROVED',
      },
      include: {
        assignments: {
          include: {
            menu: {
              include: {
                ingredients: {
                  include: {
                    inventoryItem: true
                  }
                }
              }
            }
          }
        }
      }
    })
    
    if (!menuPlan) {
      return Response.json({ error: 'Menu plan not found or not approved' }, { status: 404 })
    }
    
    // Auto-generate items from menu plan
    const autoGeneratedItems = calculateItemsFromMenuPlan(menuPlan)
    validated.data.autoGeneratedItems = autoGeneratedItems
  }
  
  const plan = await db.procurementPlan.create({
    data: {
      ...validated.data,
      sppgId: session.user.sppgId,
      allocatedBudget: 0,
      usedBudget: 0,
      remainingBudget: validated.data.totalBudget,
    }
  })
  
  return Response.json({ success: true, data: plan }, { status: 201 })
}
```

---

## üéØ Phase 2: Approval Workflow (Priority 1)

### **What's Already Done** ‚úÖ
- ‚úÖ Schema: `submissionNotes`, `approvalNotes`, `rejectionReason`, `cancellationReason`
- ‚úÖ Types: Action interfaces added
- ‚úÖ Validation: Action schemas added

### **What Needs to be Done** ‚è≥

#### 1. Update PlanActionsWrapper with Modals

**File:** `src/features/sppg/procurement/plans/components/PlanActionsWrapper.tsx`

```typescript
import { useState } from 'react'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { Textarea } from '@/components/ui/textarea'
import { useSubmitPlan, useApprovePlan, useRejectPlan, useCancelPlan } from '../hooks'

export function PlanActionsWrapper({ planId, currentStatus }: Props) {
  const [showSubmitDialog, setShowSubmitDialog] = useState(false)
  const [showApproveDialog, setShowApproveDialog] = useState(false)
  const [showRejectDialog, setShowRejectDialog] = useState(false)
  const [showCancelDialog, setShowCancelDialog] = useState(false)
  
  const { mutate: submitPlan, isPending: isSubmitting } = useSubmitPlan()
  const { mutate: approvePlan, isPending: isApproving } = useApprovePlan()
  const { mutate: rejectPlan, isPending: isRejecting } = useRejectPlan()
  const { mutate: cancelPlan, isPending: isCancelling } = useCancelPlan()

  return (
    <>
      <Card>
        <CardContent className="flex justify-between items-center p-6">
          {currentStatus === 'DRAFT' && (
            <Button onClick={() => setShowSubmitDialog(true)}>
              <Send className="mr-2 h-4 w-4" />
              Ajukan Persetujuan
            </Button>
          )}
          
          {currentStatus === 'SUBMITTED' && canApprove && (
            <div className="flex gap-2">
              <Button onClick={() => setShowApproveDialog(true)}>
                <CheckCircle className="mr-2 h-4 w-4" />
                Setujui
              </Button>
              <Button variant="destructive" onClick={() => setShowRejectDialog(true)}>
                <XCircle className="mr-2 h-4 w-4" />
                Tolak
              </Button>
            </div>
          )}
          
          {['DRAFT', 'SUBMITTED'].includes(currentStatus) && (
            <Button variant="outline" onClick={() => setShowCancelDialog(true)}>
              <Ban className="mr-2 h-4 w-4" />
              Batalkan Rencana
            </Button>
          )}
        </CardContent>
      </Card>

      {/* Submit Dialog */}
      <Dialog open={showSubmitDialog} onOpenChange={setShowSubmitDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Ajukan Persetujuan</DialogTitle>
          </DialogHeader>
          <Form onSubmit={(data) => {
            submitPlan({ planId, submissionNotes: data.notes })
            setShowSubmitDialog(false)
          }}>
            <FormField name="notes">
              <FormLabel>Catatan Pengajuan (Opsional)</FormLabel>
              <Textarea
                placeholder="Tambahkan catatan untuk approver..."
                rows={4}
              />
            </FormField>
            <Button type="submit" disabled={isSubmitting}>
              {isSubmitting ? 'Mengajukan...' : 'Ajukan'}
            </Button>
          </Form>
        </DialogContent>
      </Dialog>

      {/* Approve Dialog */}
      <Dialog open={showApproveDialog} onOpenChange={setShowApproveDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Setujui Rencana</DialogTitle>
          </DialogHeader>
          <Form onSubmit={(data) => {
            approvePlan({ planId, approvalNotes: data.notes })
            setShowApproveDialog(false)
          }}>
            <FormField name="notes">
              <FormLabel>Catatan Approval (Opsional)</FormLabel>
              <Textarea placeholder="Catatan approval..." rows={4} />
            </FormField>
            <Button type="submit" disabled={isApproving}>
              {isApproving ? 'Menyetujui...' : 'Setujui Rencana'}
            </Button>
          </Form>
        </DialogContent>
      </Dialog>

      {/* Reject Dialog */}
      <Dialog open={showRejectDialog} onOpenChange={setShowRejectDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Tolak Rencana</DialogTitle>
          </DialogHeader>
          <Form onSubmit={(data) => {
            rejectPlan({ planId, rejectionReason: data.reason })
            setShowRejectDialog(false)
          }}>
            <FormField name="reason">
              <FormLabel>Alasan Penolakan *</FormLabel>
              <Textarea
                placeholder="Jelaskan alasan penolakan dan saran perbaikan..."
                rows={4}
                required
              />
            </FormField>
            <Button type="submit" variant="destructive" disabled={isRejecting}>
              {isRejecting ? 'Menolak...' : 'Tolak Rencana'}
            </Button>
          </Form>
        </DialogContent>
      </Dialog>

      {/* Cancel Dialog - similar structure */}
    </>
  )
}
```

#### 2. Create Action Hooks

**File:** `src/features/sppg/procurement/plans/hooks/usePlanActions.ts`

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { plansApi } from '../api'
import { toast } from 'sonner'

export function useSubmitPlan() {
  const queryClient = useQueryClient()
  
  return useMutation({
    mutationFn: (data: { planId: string; submissionNotes?: string }) =>
      plansApi.submit(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['procurement-plans'] })
      toast.success('Rencana berhasil diajukan untuk persetujuan')
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Gagal mengajukan rencana')
    },
  })
}

export function useApprovePlan() {
  const queryClient = useQueryClient()
  
  return useMutation({
    mutationFn: (data: { planId: string; approvalNotes?: string }) =>
      plansApi.approve(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['procurement-plans'] })
      toast.success('Rencana berhasil disetujui')
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Gagal menyetujui rencana')
    },
  })
}

export function useRejectPlan() {
  const queryClient = useQueryClient()
  
  return useMutation({
    mutationFn: (data: { planId: string; rejectionReason: string }) =>
      plansApi.reject(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['procurement-plans'] })
      toast.success('Rencana ditolak')
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Gagal menolak rencana')
    },
  })
}

export function useCancelPlan() {
  const queryClient = useQueryClient()
  
  return useMutation({
    mutationFn: (data: { planId: string; cancellationReason: string }) =>
      plansApi.cancel(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['procurement-plans'] })
      toast.success('Rencana dibatalkan')
    },
    onError: (error: Error) => {
      toast.error(error.message || 'Gagal membatalkan rencana')
    },
  })
}
```

#### 3. Add API Endpoints

**File:** `src/app/api/sppg/procurement/plans/[id]/submit/route.ts`

```typescript
export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const session = await auth()
  if (!session?.user?.sppgId) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { id } = await params
  const body = await request.json()
  
  const validated = submitPlanSchema.safeParse({ planId: id, ...body })
  if (!validated.success) {
    return Response.json({ error: 'Validation failed' }, { status: 400 })
  }

  const plan = await db.procurementPlan.update({
    where: {
      id,
      sppgId: session.user.sppgId,
      approvalStatus: 'DRAFT', // Can only submit drafts
    },
    data: {
      approvalStatus: 'SUBMITTED',
      submittedBy: session.user.id,
      submittedAt: new Date(),
      submissionNotes: validated.data.submissionNotes,
    },
  })

  return Response.json({ success: true, data: plan })
}
```

Similar routes for `/approve`, `/reject`, `/cancel`.

---

## üéØ Phase 3: Production From Plan Page (Priority 2)

**File:** `src/app/(sppg)/production/new/from-plan/[planId]/page.tsx`

```typescript
import { db } from '@/lib/prisma'
import { auth } from '@/auth'
import { ProductionReadinessCard } from '@/features/sppg/procurement/integration/components'

export default async function ProductionFromPlanPage({ params }: Props) {
  const session = await auth()
  const { planId } = await params
  
  // Fetch approved plan
  const plan = await db.procurementPlan.findFirst({
    where: {
      id: planId,
      sppgId: session.user.sppgId,
      approvalStatus: 'APPROVED',
    },
    include: {
      program: true,
    },
  })
  
  if (!plan) {
    redirect('/procurement/plans')
  }
  
  // Fetch programs and inventory
  const [programs, inventoryItems] = await Promise.all([
    db.nutritionProgram.findMany({
      where: { sppgId: session.user.sppgId, status: 'ACTIVE' },
    }),
    db.inventoryItem.findMany({
      where: { sppgId: session.user.sppgId, isActive: true },
    }),
  ])
  
  return (
    <div className="container mx-auto py-6 space-y-6">
      <ProcurementPageHeader
        title="Buat Produksi dari Procurement Plan"
        description={`Plan: ${plan.planName}`}
        breadcrumbs={['Production', 'New', 'From Plan']}
      />
      
      <ProductionReadinessCard
        planId={planId}
        programs={programs}
        inventoryItems={inventoryItems}
        onSuccess={(productionId) => router.push(`/production/${productionId}`)}
      />
    </div>
  )
}
```

Add link in PlanDetail:

```typescript
{plan.approvalStatus === 'APPROVED' && (
  <Card>
    <CardHeader>
      <CardTitle>Quick Actions</CardTitle>
    </CardHeader>
    <CardContent>
      <Button asChild>
        <Link href={`/production/new/from-plan/${plan.id}`}>
          <Plus className="mr-2 h-4 w-4" />
          Buat Produksi dari Plan Ini
        </Link>
      </Button>
    </CardContent>
  </Card>
)}
```

---

## üéØ Phase 4: Related Records Display (Priority 3)

**File:** `src/app/(sppg)/procurement/plans/[id]/page.tsx`

Update to fetch related records:

```typescript
const [plan, relatedProductions, relatedDistributions] = await Promise.all([
  // ... existing plan fetch ...
  
  // Fetch productions using this plan
  db.foodProduction.findMany({
    where: {
      planId: id,
      program: { sppgId: session.user.sppgId },
    },
    include: {
      menu: { select: { menuName: true } },
      program: { select: { name: true } },
    },
    orderBy: { productionDate: 'desc' },
    take: 10,
  }),
  
  // Fetch distributions using this plan
  db.foodDistribution.findMany({
    where: {
      planId: id,
      sppgId: session.user.sppgId,
    },
    include: {
      production: {
        select: {
          menu: { select: { menuName: true } },
        },
      },
    },
    orderBy: { distributionDate: 'desc' },
    take: 10,
  }),
])
```

Add to detail page:

```typescript
{/* Related Productions */}
{relatedProductions.length > 0 && (
  <Card>
    <CardHeader>
      <CardTitle>Produksi Terkait ({relatedProductions.length})</CardTitle>
      <CardDescription>
        Produksi yang menggunakan rencana pengadaan ini
      </CardDescription>
    </CardHeader>
    <CardContent>
      <div className="space-y-2">
        {relatedProductions.map((prod) => (
          <Link
            key={prod.id}
            href={`/production/${prod.id}`}
            className="flex items-center justify-between p-3 rounded-lg hover:bg-accent"
          >
            <div>
              <p className="font-medium">{prod.menu.menuName}</p>
              <p className="text-sm text-muted-foreground">
                {format(prod.productionDate, 'PPP')} ‚Ä¢ {prod.plannedPortions} porsi
              </p>
            </div>
            <Badge>{prod.status}</Badge>
          </Link>
        ))}
      </div>
    </CardContent>
  </Card>
)}
```

---

## üìã Implementation Checklist

### Phase 1: Menu Plan Integration
- [ ] Create `useApprovedMenuPlans` hook
- [ ] Create `useMenuPlanData` hook  
- [ ] Update `PlanForm.tsx` with tabs/toggle
- [ ] Add menu plan selection UI
- [ ] Implement auto-populate logic
- [ ] Update API to handle menuPlanId
- [ ] Test menu plan flow end-to-end

### Phase 2: Approval Workflow  
- [ ] Update `PlanActionsWrapper.tsx` with modals
- [ ] Create action hooks (submit, approve, reject, cancel)
- [ ] Add API routes for actions
- [ ] Add approval history display
- [ ] Test approval workflow

### Phase 3: Production From Plan
- [ ] Create `/production/new/from-plan/[planId]/page.tsx`
- [ ] Add link in approved plan detail
- [ ] Test production creation from plan

### Phase 4: Related Records
- [ ] Fetch related productions in detail page
- [ ] Fetch related distributions in detail page
- [ ] Display related records with links
- [ ] Add statistics cards

### Final Testing
- [ ] Test complete flow: Manual plan creation
- [ ] Test complete flow: Plan from menu
- [ ] Test approval workflow with notes
- [ ] Test production creation from plan
- [ ] Test related records display
- [ ] Verify all fields saving correctly
- [ ] Check multi-tenant isolation

---

## üéâ Expected Outcome

After 100% implementation:

1. **Menu Plan Integration** ‚úÖ
   - Users can create procurement plans manually OR from approved menu plans
   - Budget and items auto-calculated from menu data
   - Seamless integration between menu planning and procurement

2. **Complete Approval Workflow** ‚úÖ
   - Submit with notes
   - Approve with notes
   - Reject with reason
   - Cancel with reason
   - Full audit trail

3. **Production Integration** ‚úÖ
   - Create production directly from approved plans
   - Dedicated page for plan-based production
   - Professional UX (no modals!)

4. **Related Records** ‚úÖ
   - See all productions using this plan
   - See all distributions from this plan
   - Track plan utilization

5. **100% Schema Coverage** ‚úÖ
   - All fields in Prisma schema have UI implementation
   - All relations properly displayed
   - No unused database fields

---

**Next Steps:** Start implementing Phase 1 (Menu Plan Integration) first, as it has the most business value.
