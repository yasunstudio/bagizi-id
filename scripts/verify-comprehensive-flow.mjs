#!/usr/bin/env node
/**
 * Verify Comprehensive Flow Data
 * Checks Menu Plan â†’ Procurement â†’ Production â†’ Distribution
 */

import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function verify() {
  console.log('ðŸ” Verifying Comprehensive Flow Data...\n')
  
  try {
    // 1. Menu Plan (Comprehensive Flow - dengan assignments)
    const menuPlan = await prisma.menuPlan.findFirst({
      where: { 
        id: 'menu-plan-DEMO-2025-2025-11' // Comprehensive flow menu plan
      },
      include: {
        _count: {
          select: { assignments: true }
        },
        assignments: {
          take: 5,
          orderBy: { assignedDate: 'asc' },
          include: {
            menu: { select: { menuName: true } }
          }
        }
      }
    })
    
    console.log('ðŸ“… MENU PLAN:')
    if (menuPlan) {
      console.log('  Name:', menuPlan.name)
      console.log('  Status:', menuPlan.status)
      console.log('  Working Days:', menuPlan.totalDays)
      console.log('  Total Assignments:', menuPlan._count.assignments)
      console.log('  Estimated Cost: Rp', menuPlan.totalEstimatedCost?.toLocaleString('id-ID') || '0')
      console.log('  First 5 Menu Assignments:')
      menuPlan.assignments.forEach((a, i) => {
        console.log(`    ${i + 1}. ${a.menu.menuName} - ${a.assignedDate.toLocaleDateString('id-ID')}`)
      })
    } else {
      console.log('  âŒ No menu plan found')
    }
    console.log('')
    
    // 2. Procurement Plan
    const procPlan = await prisma.procurementPlan.findFirst({
      where: { 
        planName: { contains: 'Pengadaan November 2025 (dari Menu Plan)' }
      },
      include: {
        menuPlan: { select: { name: true } },
        procurements: { select: { id: true, status: true, totalAmount: true } }
      }
    })
    
    console.log('ðŸ›’ PROCUREMENT PLAN:')
    if (procPlan) {
      console.log('  Name:', procPlan.planName)
      console.log('  Linked to Menu Plan: âœ…', procPlan.menuPlan?.name || 'Not linked')
      console.log('  Total Budget: Rp', procPlan.totalBudget?.toLocaleString('id-ID') || '0')
      console.log('  Allocated Budget: Rp', procPlan.allocatedBudget?.toLocaleString('id-ID') || '0')
      
      const items = procPlan.autoGeneratedItems
      console.log('  Items Count:', items?.items?.length || 0)
      
      if (items?.items?.length > 0) {
        console.log('  Sample Items (first 5):')
        items.items.slice(0, 5).forEach((item, i) => {
          console.log(`    ${i + 1}. ${item.itemName} - ${item.estimatedQuantity} ${item.unit} - Rp ${item.estimatedTotal?.toLocaleString('id-ID')}`)
        })
      }
      
      console.log('  Procurement Orders:', procPlan.procurements.length)
      if (procPlan.procurements.length > 0) {
        procPlan.procurements.forEach((p, i) => {
          console.log(`    ${i + 1}. Status: ${p.status} - Rp ${p.totalAmount?.toLocaleString('id-ID')}`)
        })
      }
    } else {
      console.log('  âŒ No procurement plan found')
    }
    console.log('')
    
    // 3. Productions
    const productions = await prisma.foodProduction.findMany({
      where: {
        procurementPlanId: procPlan?.id,
        productionDate: {
          gte: new Date('2025-11-01'),
          lte: new Date('2025-11-05')
        }
      },
      include: {
        menu: { select: { menuName: true } }
      },
      orderBy: { productionDate: 'asc' }
    })
    
    console.log('ðŸ­ PRODUCTIONS (Week 1 - Nov 1-5):')
    console.log('  Count:', productions.length)
    if (productions.length > 0) {
      productions.forEach((p, i) => {
        const date = p.productionDate.toLocaleDateString('id-ID', { weekday: 'short', day: '2-digit', month: 'short' })
        console.log(`  ${i + 1}. ${date} - ${p.menu.menuName}`)
        console.log(`     Status: ${p.status} | Portions: ${p.actualPortions} | Cost: Rp ${p.totalCost?.toLocaleString('id-ID')}`)
      })
    } else {
      console.log('  â„¹ï¸  No productions found (suppliers might not be available)')
    }
    console.log('')
    
    // 4. Distributions
    const distributions = await prisma.foodDistribution.findMany({
      where: {
        distributionDate: {
          gte: new Date('2025-11-01'),
          lte: new Date('2025-11-05')
        },
        programId: menuPlan?.programId
      },
      orderBy: { distributionDate: 'asc' }
    })
    
    console.log('ðŸšš DISTRIBUTIONS (Week 1 - Nov 1-5):')
    console.log('  Count:', distributions.length)
    if (distributions.length > 0) {
      distributions.forEach((d, i) => {
        const date = d.distributionDate.toLocaleDateString('id-ID', { weekday: 'short', day: '2-digit', month: 'short' })
        console.log(`  ${i + 1}. ${date} - Recipients: ${d.actualRecipients} - Status: ${d.status}`)
        console.log(`     Cost per Meal: Rp ${d.totalCostPerMeal?.toLocaleString('id-ID')}`)
      })
      
      const totalRecipients = distributions.reduce((sum, d) => sum + (d.actualRecipients || 0), 0)
      console.log(`  Total Recipients Served: ${totalRecipients} people`)
    } else {
      console.log('  â„¹ï¸  No distributions found')
    }
    console.log('')
    
    // 5. Data Flow Summary
    console.log('ðŸ“Š DATA FLOW SUMMARY:')
    console.log('  âœ… Menu Plan â†’ Created with', menuPlan?._count.assignments || 0, 'assignments')
    console.log('  âœ… Procurement Plan â†’ Linked to menu plan with', procPlan?.autoGeneratedItems?.items?.length || 0, 'items')
    console.log('  ' + (productions.length > 0 ? 'âœ…' : 'âš ï¸ ') + ' Production â†’ ' + productions.length + ' batches created')
    console.log('  ' + (distributions.length > 0 ? 'âœ…' : 'âš ï¸ ') + ' Distribution â†’ ' + distributions.length + ' deliveries completed')
    console.log('')
    
    console.log('âœ… Verification Complete!')
    
  } catch (error) {
    console.error('âŒ Error during verification:', error)
    throw error
  } finally {
    await prisma.$disconnect()
  }
}

verify().catch((error) => {
  console.error('Fatal error:', error)
  process.exit(1)
})
